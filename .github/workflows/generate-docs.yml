name: Generate Vimdoc

on:
  push:
    branches: [main]
    paths:
      - "lua/**"
      - "README.md"
      - ".github/workflows/generate-docs.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Clean doc directory
        run: |
          mkdir -p doc
          find doc -maxdepth 1 -type f ! -name '*.txt' ! -name 'tags' -delete

      - name: Convert README.md with panvimdoc
        uses: kdheepak/panvimdoc@main
        with:
          vimdoc: nvim-mybatis

      - name: Download and generate API docs
        run: |
          curl -Lq https://github.com/numToStr/lemmy-help/releases/latest/download/lemmy-help-x86_64-unknown-linux-gnu.tar.gz | tar xz
          find lua/nvim-mybatis -name '*.lua' | while read lua_file; do
            module_name=$(echo "$lua_file" | sed 's|^lua/nvim-mybatis/||; s|\.lua$||; s|/|.|g')
            ./lemmy-help -c -f "$lua_file" > "doc/$module_name.txt"
            sed -i 's/^\*M\./*nvim-mybatis./g; s/^M\./nvim-mybatis./g; s/|M\./|nvim-mybatis./g; s/`M\./`nvim-mybatis./g' "doc/$module_name.txt"
          done

      - name: Generate help tags
        run: nvim --headless -c 'helptags doc/' -c 'quit' 2>/dev/null

      - name: Commit generated documentation
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore(docs): auto-generate vimdoc"
          file_pattern: |
            doc/*.txt
            doc/tags
