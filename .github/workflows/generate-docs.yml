name: Generate Vimdoc

on:
  push:
    branches: [main]
    paths:
      - "README.md"
      - ".github/workflows/generate-docs.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Clean doc directory
        run: |
          mkdir -p doc
          find doc -maxdepth 1 -type f ! -name '*.txt' ! -name 'tags' -delete

      - name: Convert README.md with panvimdoc
        uses: kdheepak/panvimdoc@main
        with:
          vimdoc: nvim-mybatis

      - name: Install Neovim
        run: |
          sudo apt update
          sudo apt install -y neovim

      - name: Generate help tags
        run: nvim --headless -c 'helptags doc/' -c 'quit' 2>/dev/null

      - name: Commit generated documentation
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore(docs): auto-generate vimdoc"
          file_pattern: |
            doc/*.txt
            doc/tags
